



tcp是应用程序之间的通信

### Tcp报文段

<img src="C:\Users\A\AppData\Roaming\Typora\typora-user-images\image-20230503091101138.png" alt="image-20230503091101138" style="zoom:67%;" />1

源端口号： 用于多路复用/分解来自**送到上层应用的数据**，告诉报文段该主机来自哪里，传给上层哪一个协议。

### 序列号：

该报文段首字节的字节流编号，用来解决网络包乱序的问题。

### 确认应答号：

对发送来的TCP报文段的响应，值是收到的TCP报文段的序号值加1，用来解决不丢包的问题。

序列号和确认

应答序号实现可靠数据传输。

### 首部长度

首部长度中只有4个bit位，也就是最大值为15，但是单位为4个字节，

tcp最小是20个字节，但是tcp的头部的大小不是固定的，如果有选项，首部长度则会变大，且最大为 15*4=60个字节

### 窗口大小

窗口大小是用来进行流量控制，它用来告诉对端主机，接收缓冲区剩余的大小。



### 标志字段

ACK:	用于指示确认应答号值是否有效。

RST:   用于重置一个混乱的连接，或拒绝一个无效的数据段或者连接请求。

SYN:  用于建立连接，请求建立连接



### 超时重传

> 当发送端的数据到达接收主机时，接收端主机会返回一个确认应答信息，表示已收到消息

TCP针对数据包丢失的情况，会用重传机制

##### 工作方式

在发送数据的时候，设定一个定时器，当超过这个定时器的时间，没有收到对方的ACK确认应答报文，就会重发该数据。

![image-20230426201409506](C:\Users\A\AppData\Roaming\Typora\typora-user-images\image-20230426201409506.png)

### RTT（Round-Trip Time)

数据从网络一端传送到另一端所需的时间，也就是包的往返时间



### RTO(超时重传时间)

当超时时间RTO较大时，丢了老半



### 为什么要进行三次握手

1. 三次握手可以阻止重复历史连接的初始化

   什么是历史连接初始化？

   避免超时的握手报文建立连接，比如说，客户端给服务器发送第一次握手的报文，如果定时器到了，客户端给我们的服务器发送第一次握手的报文，那么超时的报文即使到了服务器也不会建立连接，因为第三次握手，客户端会通过序列号来判断这个报文是不是超时报文，如果是超时报文，则客户端会发送一个RST报文来终止这段连接。

2. 同步双方的序列号

两次握手只能保证一端的序列号被对方成功接收，三次握手才能保证双方的序列号能被接收。

- 第一次客户端发送syn报文给服务器，告诉服务器自己的序列号。
- 第二次报文发送ACK+SYN给客户端，表示服务器收到客户端的序列号。
- 第三次客户端给服务器发送ACK，表示收到服务器的syn



### 序列号

1. 接受端可以去除重复的数据
2. 接收端可以按照序列号顺序接收
3. 标识发送的数据包，哪些被收到。



#### 为什么Time_wait等待的时间是2MSL？

1. MSL是Maximum Segment Lifetime, 报文最大生存时间，它是任何报文在网络上最长的生存时间，超过这个时间报文将会被丢弃。
2. 2MSL的时间是从客户端接收到FIN后发送ACK开始计时，如果在Time_Wait时间内，因为客户端ACK没有传输到服务端，客户端又接收到重发的Fin报文，那么2MSL时间将重新计时。
3. 等待2MSL：网络中可能存在发送方的数据报，这些数据报被接收方处理后又会向对方发送响应，确保响应能够达到对方，所以一来一回需要等待2MSL时间。例如服务器发送fin之前，会发送缓冲区的数据发送给客户端，这些数据可能还存在网络，如果这些数据还没到达客户端就关闭连接，则会导致对端不能完整接收到数据





### 为什么会有Time_wait状态

主动发起关闭连接的一方，才会有time_wait状态。

需要time-wait状态：

- 防止具有相同的四元组收到上个连接的数据包，当连接关闭后，然后再重新连接，网络上可能还存在上次连接的报文，如果新连接接收旧的报文，那么会产生数据混乱的问题。经过2MSL这个时间，足以让两个方向上的数据包再网络上被丢弃，使得上一次连接的数据包在网络上自然消失，再出现的数据包一定是新建连接所产生的。
- 保证最后的ack能让被动关闭方给接收到，从而正常帮助正常关闭。

#### TIME_WAIT过多有什么危害？

过多的TIME-WAIT状态主要的危害有两种：

- 1.内存资源占用。
- 2.对端口资源的占用，一个TCP连接至少消耗一个本地端口。

### 什么是滑动窗口



### 拥塞控制算法

拥塞控制防止过多的数据注入到网络中，使得网络中的路由器或者链路过载。

拥塞控制算法有：

1. 慢启动
2. 拥塞避免
3. 拥塞发生
4. 快速恢复



#### 慢启动算法

当发送方每接收到一个ACK，拥塞窗口值cwnd就会+1.

慢启动算法它发包的增长个数是2的次方

1. 有一个慢启动门限<<ssthresh 时，使用慢启动算法。
2. 当慢启动门限 >=ssthresh, 就会使用拥塞避免算法



#### 拥塞避免算法

​	每当接收到一个ack，cwnd增长 1/cwnd.

拥塞避免算法发包的数量，由之前的指数增长变为线性增长。

当触发超时重传，则会进入拥塞发生算法。

#### 拥塞发生算法

ssthresh和cwnd的值会发生变化。

##### (1)发生超时重传算法

大量的数据包丢失

1.ssthread设为cwnd/2

2.cwnd设置为1

<img src="C:\Users\A\AppData\Roaming\Typora\typora-user-images\image-20230503114307767.png" alt="image-20230503114307767" style="zoom:67%;" />1

#### (2)快速重传拥塞算法

TCP认为这种情况不严重，因为大部分没丢，只丢一小部分，则ssthsh和cwnd发生如下变化：

1. cwnd=cwnd/2，也就是设置为原来的一半。

2. ssthresh=cwnd

3. 进入快速恢复算法

   <img src="C:\Users\A\AppData\Roaming\Typora\typora-user-images\image-20230503115229701.png" alt="image-20230503115229701" style="zoom:67%;" />1

   快速重传和快速恢复算法一般同时使用，

   